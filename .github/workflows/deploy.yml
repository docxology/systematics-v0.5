name: Deploy to Shuttle

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual deployment

env:
  CARGO_TERM_COLOR: always
  SCCACHE_GHA_ENABLED: "true"
  RUSTC_WRAPPER: "sccache"

jobs:
  deploy:
    name: Deploy to Shuttle
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Install wasm32 target
        run: rustup target add wasm32-unknown-unknown

      - name: Install Trunk
        run: |
          wget -qO- https://github.com/trunk-rs/trunk/releases/download/v0.20.3/trunk-x86_64-unknown-linux-gnu.tar.gz | tar -xzf-
          sudo mv trunk /usr/local/bin/

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      # CRITICAL: Build frontend BEFORE deploying backend
      - name: Build frontend with Trunk
        working-directory: frontend
        run: trunk build --release

      # Verify frontend build succeeded
      - name: Verify frontend dist exists
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "ERROR: frontend/dist not found!"
            exit 1
          fi
          ls -la frontend/dist/

      # Deploy to Shuttle (includes backend build with --features shuttle)
      - name: Deploy to Shuttle
        uses: shuttle-hq/deploy-action@v1
        with:
          deploy-key: ${{ secrets.SHUTTLE_API_KEY }}
          working-directory: backend
          cargo-shuttle-version: "0.50.0"

      - name: Print sccache stats
        run: sccache --show-stats
